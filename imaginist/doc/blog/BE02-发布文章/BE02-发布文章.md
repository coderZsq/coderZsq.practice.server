# BE02. 发布文章

由朱双泉创建, 最后修改于四月 08, 2021

## 文档变更历史

| 版本 |   日期    | 负责人 | 说明 |
| :--: | :-------: | :----: | :--: |
|  v1  | 2021.4.08 | 朱双泉 | 创建 |

## 0xFF 如何启动

1. [github](https://github.com/coderZsq) 下载 [coderZsq.product.doc](https://codeload.github.com/coderZsq/coderZsq.product.doc/zip/refs/heads/master) 仓库;
2. 解压 /02-技术文档/01-源代码/BE02-src.zip;
3. 使用 idea 通过 pom.xml 载入项目;
4. 创建 imaginist 数据库, 字符集使用 utf8mb4;
5. 执行 article.sql 中的创建表语句;
6. 运行 ArticleTest.java 中的 saveStockArticles() 插入数据;
7. 运行 ImaginistApplication.java 启动 SpringBoot;

## 0x00 本次更新

- 将项目名称从 recorder 改为 imaginist;
- 修改数据库 article 表中字段;
- pojo 对象中新增 preview 字段;
- mapstruct 对 date 字段进行转换;
- 新增 mysql 输出日志;
- 新增保存文章接口;
- 新增上传文件接口.

## 0x01 架构更新

```diff
+ src/main/java/com/sq/imaginist/common/util/Strings.java
+ src/main/java/com/sq/imaginist/common/util/Uploads.java
+ src/upload/img

.
├── src
│   └── main
│       └── java
│           └── com
│               └── sq
│                   └── imaginist
│                       └── common
│                           └── util
│                               ├── Strings.java
│                               └── Uploads.java
└── upload
    └── img
```

## 0x02 修改表结构

```sql
ALTER TABLE article ADD preview longtext NOT NULL COMMENT '预览' AFTER content;
```

- 使用 text 存储会有长度限制, 报如下错误:

```
Error: Data too long for column 'preview' at row 1
    at PromisePool.execute (/Users/zhushuangquan/Codes/GitHub/coderZsq.practice.web/imaginist/node_modules/mysql2/promise.js:358:22)
    at saveStockPreviewColumn (/Users/zhushuangquan/Codes/GitHub/coderZsq.practice.web/imaginist/src/test/article.test.js:31:22)
    at processTicksAndRejections (node:internal/process/task_queues:94:5) {
  code: 'ER_DATA_TOO_LONG',
  errno: 1406,
  sqlState: '22001',
  sqlMessage: "Data too long for column 'preview' at row 1"
}
```

- 这里使用 longtext 进行存储, 修改表结构如下:

```sql
DROP TABLE IF EXISTS `article`;
CREATE TABLE `article` (
  `id` smallint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `title` varchar(30) NOT NULL DEFAULT '' COMMENT '标题',
  `type` varchar(10) NOT NULL DEFAULT '' COMMENT '类型',
  `words` smallint unsigned NOT NULL DEFAULT '0' COMMENT '字数',
  `duration` smallint unsigned NOT NULL DEFAULT '0' COMMENT '阅读时长',
  `date` datetime DEFAULT NULL COMMENT '日期',
  `content` text NOT NULL COMMENT '正文',
  `preview` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT '预览',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=112 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='文章';
```

## 0x03 修改对象存储

1. @TableId(type = IdType.AUTO) 注解是为了保存获取主键使用;
2. 新增 preview 字段存放 markdown 生成的 html, 提升性能.

```java
@Data
public class Article {
    //主键
    @TableId(type = IdType.AUTO)
    private Integer id;
    //标题
    private String title;
    //类型
    private String type;
    //正文
    private String content;
    //预览
    private String preview;
    //字数
    private Integer words;
    //阅读时长
    private Integer duration;
    //日期
    private Date date;
}
```

## 0x04 请求参数校验

```java
@Data
public class ArticleReqVo {
    @ApiModelProperty("id [大于0代表更新, 否则代表添加]")
    private Integer id;

    @NotBlank(message = "标题不能为空")
    @ApiModelProperty(value = "标题 [不能为空]", required = true)
    private String title;

    @NotBlank(message = "类型不能为空")
    @ApiModelProperty(value = "类型 [不能为空]", required = true)
    private String type;

    @NotBlank(message = "正文不能为空")
    @ApiModelProperty(value = "正文 [不能为空]", required = true)
    private String content;

    @NotBlank(message = "预览不能为空")
    @ApiModelProperty(value = "预览 [不能为空]", required = true)
    private String preview;

    @Min(value = 0, message = "字数不能是负数")
    @ApiModelProperty(value = "字数 [不能是负数]", required = true)
    private Integer words;

    @Min(value = 0, message = "阅读时长不能是负数")
    @ApiModelProperty(value = "阅读时长 [不能是负数]", required = true)
    private Integer duration;

    @Min(value = 0, message = "日期不能是负数")
    @ApiModelProperty(value = "日期 [不能是负数]", required = true)
    private Long date;
}
```

## 0x05 mapstruct 对象转换

- 由于 js 和 java 的 Date 格式不同, 解决方案为 js 传时间戳, 使用 mapstruct 转换成 Date 对象.

```java
@Mapper(uses = {
        MapStructFormatter.class
})
public interface MapStructs {
    MapStructs INSTANCE = Mappers.getMapper(MapStructs.class);

    ArticleVo po2vo(Article po);
    @Mapping(source = "date",
            target = "date",
            qualifiedBy = MapStructFormatter.Mills2Date.class)
    Article reqVo2po(ArticleReqVo reqVo);
}
```

## 0x06 mysql 日志输出

```yml
logging:
  level:
    com.sq.imaginist: debug
```

```
2021-04-08 16:15:06.459 DEBUG 78118 --- [nio-8080-exec-4] c.s.i.mapper.ArticleMapper.selectPage    : ==> Parameters: 10(Long), 5(Long)
2021-04-08 16:15:06.485 DEBUG 78118 --- [nio-8080-exec-5] c.s.i.m.A.selectPage_mpCount             : ==>  Preparing: SELECT COUNT(*) FROM article
2021-04-08 16:15:06.485 DEBUG 78118 --- [nio-8080-exec-5] c.s.i.m.A.selectPage_mpCount             : ==> Parameters:
2021-04-08 16:15:06.486 DEBUG 78118 --- [nio-8080-exec-5] c.s.i.m.A.selectPage_mpCount             : <==      Total: 1
2021-04-08 16:15:06.487 DEBUG 78118 --- [nio-8080-exec-5] c.s.i.mapper.ArticleMapper.selectPage    : ==>  Preparing: SELECT id,title,type,content,preview,words,duration,date FROM article ORDER BY date DESC LIMIT ?,?
```

## 0x07 保存接口实现

1. 由于 MybatisPlus 默认不支持保存返回主键, 这里需要进行自定义;
2. 自定义需要 po 对象 添加上述注解;

```java
public interface ArticleMapper extends BaseMapper<Article> {
    @Override
    @Insert("INSERT INTO article " +
            "(id, title, type, words, duration, date, content, preview)" +
            "VALUES" +
            "(#{id}, #{title}, #{type}, #{words}, #{duration}, #{date}, #{content}, #{preview})")
    @Options(useGeneratedKeys = true, keyProperty = "id", keyColumn = "id")
    int insert(Article article);
}
```

3. 在 yml 配置 use-generated-keys: true;

```yml
mybatis-plus:
  type-aliases-package: com.sq.imaginist.pojo
  configuration:
    use-generated-keys: true
  global-config:
    db-config:
      id-type: auto
```

4. 会自动将返回的主键设置到注解对应的值中;

```java
@Service
@Transactional
public class ArticleServiceImpl extends ServiceImpl<ArticleMapper, Article> implements ArticleService {
    ...
    @Override
    public Integer saveGeneratedId(Article article) {
        if (baseMapper.insert(article) > 0) {
            return article.getId();
        }
        return null;
    }
}
```

## 0x07 保存接口碰到的坑

1. 同样是 post 请求， 使用 query 传参 spring 可以获取到数据 但使用 body 传参就都是 null, 但使用 query 传输 html 文本会报以下错误:

```
The valid characters are defined in RFC 7230 and RFC 3986
```

2. 我们这里使用 body 传参时需要添加 application/x-www-form-urlencoded 请求头, 不然 raw 格式的 Spring 获取不到数据, 并报非法访问的错误:

```
WARNING: An illegal reflective access operation has occurred
WARNING: Illegal reflective access by org.springframework.cglib.core.ReflectUtils (file:/Users/zhushuangquan/.m2/repository/org/springframework/spring-core/5.2.9.RELEASE/spring-core-5.2.9.RELEASE.jar) to method java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain)
WARNING: Please consider reporting this to the maintainers of org.springframework.cglib.core.ReflectUtils
WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
WARNING: All illegal access operations will be denied in a future release
```

3. 非法访问可以在 vm-options 中添加以下内容解决.

```
Vm-options --illegal-access=deny --add-opens java.base/java.lang=ALL-UNNAMED
```

## 0x08 上传接口实现

1. 新增自定义配置类;

```java
@ConfigurationProperties("imaginist")
@Component
@Data
public class ImaginistProperties implements ApplicationContextAware {
    ...
    private Upload upload;
    ...
    @Data
    public static class Upload {
        private String basePath;
        private String uploadPath;
        private String imagePath;
        private String videoPath;

        public String getImageRelativePath() {
            return uploadPath + imagePath;
        }

        public String getVideoRelativePath() {
            return uploadPath + videoPath;
        }
    }
}
```

2. 新增自定义配置路径;

```yml
imaginist:
  upload:
    base-path: /Users/zhushuangquan/Codes/GitHub/coderZsq.practice.server/imaginist/
    upload-path: upload/
    image-path: img/
    video-path: video/
```

3. 新增上传工具类;

```java
private static String uploadFile(MultipartFilemultipartFile, String dir) throws Exception {
    if (multipartFile == null || multipartFile.getSize() == 0) return null;
    // 文件扩展名
    String extension = FilenameUtils.getExtension(multipartFile.getOriginalFilename());
    // 文件名
    String filename = UUID.randomUUID() + "." + extension;
    // 文件路径 (相对, upload.img/xx.jpg)
    String filepath = dir + filename;
    // 文件路径 (绝对, F:/upload/img/xxx.jpg)
    String fullFilepath = UPLOAD.getBasePath() + filepath;
    File file = new File(fullFilepath);
    // 如果文件夹不存在, 那就会创建文件夹
    FileUtils.forceMkdirParent(file);
    // 剪切
    multipartFile.transferTo(file);
    // 返回图片对象
    return filepath;
}
```

4. 新增上传图片接口;

```java
public class ArticleController extends BaseController<Article, ArticleReqVo> {
    ...
    @PostMapping("/uploadImg")
    @ApiOperation("图片上传")
    public JsonVo uploadImg(MultipartFile img) throws Exception {
        return new DataJsonVo<>(Uploads.uploadImage(img));
    }
    ...
}
```

5. 配置静态服务器存放上传的文件;

```yml
spring:
  servlet:
    multipart:
      max-file-size: 20MB
      max-request-size: 20MB
  resources:
    static-locations:
      - file:///${imaginist.upload.base-path}
```

## 0x09 接口文档

- POST /articles/save 添加或更新.

|   字段   |   说明   |   类型   |             备注              | 是否必填 |
| :------: | :------: | :------: | :---------------------------: | :------: |
|    id    |   主键   |   int    | 大于 0 代表更新, 否则代表添加 |    否    |
|  title   |   标题   |  string  |           不能为空            |    是    |
|   type   |   类型   |  string  |           不能为空            |    是    |
| content  |   正文   |  string  |           不能为空            |    是    |
| preview  |   预览   |  string  |           不能为空            |    是    |
|  words   |   字数   |   int    |          不能是负数           |    是    |
| duration | 阅读时长 |   int    |          不能是负数           |    是    |
|   date   |   日期   | datetime |      毫秒数, 不能是负数       |    是    |

- POST /articles/uploadImg 图片上传.

| 字段 | 说明 | 类型 |        备注         | 是否必填 |
| :--: | :--: | :--: | :-----------------: | :------: |
| img  | 图片 | file | 上传 multipart 文件 |    是    |
