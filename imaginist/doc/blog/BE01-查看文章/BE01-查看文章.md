# BE01. 查看文章

由朱双泉创建, 最后修改于三月 24, 2021

## 文档变更历史

| 版本 |   日期    | 负责人 | 说明 |
| :--: | :-------: | :----: | :--: |
|  v1  | 2021.3.24 | 朱双泉 | 创建 |

## 0xFF 如何启动

1. [github](https://github.com/coderZsq) 下载 [coderZsq.product.doc](https://codeload.github.com/coderZsq/coderZsq.product.doc/zip/refs/heads/master) 仓库;
2. 解压 /02-技术文档/01-源代码/BE01-src.zip;
3. 使用 idea 通过 pom.xml 载入项目;
4. 创建 recorder 数据库, 字符集使用 utf8mb4;
5. 执行 article.sql 中的创建表语句;
6. 运行 ArticleTest.java 中的 saveStockArticles() 插入数据;
7. 运行 RecorderApplication.java 启动 SpringBoot;

## 0x00 环境搭建

- 使用 Spring 全家桶进行项目的搭建;
- 使用 MySQL 作为数据库存储;
- 使用 Java 作为主要的开发语言.

## 0x01 架构搭建

1. 先基于 SpringBoot 搭建基础架构;
2. 具体集成及相关架构搭建可以阅读[源码](https://github.com/coderZsq/coderZsq.practice.server/tree/master/recorder).

```
.
├── article.sql
├── pom.xml
└── src
    ├── main
    │   ├── java
    │   │   └── com
    │   │       └── sq
    │   │           └── recorder
    │   │               ├── RecorderApplication.java
    │   │               ├── common
    │   │               │   ├── cfg
    │   │               │   │   ├── MyBatisPlusCfg.java
    │   │               │   │   ├── SwaggerCfg.java
    │   │               │   │   ├── ValidatorCfg.java
    │   │               │   │   └── WebCfg.java
    │   │               │   ├── enhance
    │   │               │   │   ├── MpLambdaQueryWrapper.java
    │   │               │   │   ├── MpPage.java
    │   │               │   │   └── MpQueryWrapper.java
    │   │               │   ├── exception
    │   │               │   │   └── CommonException.java
    │   │               │   ├── mapStruct
    │   │               │   │   ├── MapStructFormatter.java
    │   │               │   │   └── MapStructs.java
    │   │               │   ├── prop
    │   │               │   │   └── RecorderProperties.java
    │   │               │   └── util
    │   │               │       ├── JsonVos.java
    │   │               │       └── Streams.java
    │   │               ├── controller
    │   │               │   ├── ArticleController.java
    │   │               │   └── BaseController.java
    │   │               ├── mapper
    │   │               │   └── ArticleMapper.java
    │   │               ├── pojo
    │   │               │   ├── po
    │   │               │   │   └── Article.java
    │   │               │   ├── result
    │   │               │   │   └── CodeMsg.java
    │   │               │   └── vo
    │   │               │       ├── DataJsonVo.java
    │   │               │       ├── JsonVo.java
    │   │               │       ├── PageJsonVo.java
    │   │               │       ├── PageVo.java
    │   │               │       ├── list
    │   │               │       │   └── ArticleVo.java
    │   │               │       └── req
    │   │               │           ├── page
    │   │               │           │   ├── ArticlePageReqVo.java
    │   │               │           │   ├── KeywordPageReqVo.java
    │   │               │           │   └── PageReqVo.java
    │   │               │           └── save
    │   │               │               └── ArticleReqVo.java
    │   │               └── service
    │   │                   ├── ArticleService.java
    │   │                   └── impl
    │   │                       └── ArticleServiceImpl.java
    │   └── resources
    │       ├── application-dev.yml
    │       └── application.yml
    └── test
        └── java
            └── com
                └── sq
                    └── recorder
                        └── ArticleTest.java
```

## 0x02 数据库设计

```sql
DROP TABLE IF EXISTS `article`;
CREATE TABLE `article`
(
    `id`       smallint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
    `title`    varchar(30)       NOT NULL DEFAULT '' COMMENT '标题',
    `type`     varchar(10)       NOT NULL DEFAULT '' COMMENT '类型',
    `words`    smallint unsigned NOT NULL DEFAULT '0' COMMENT '字数',
    `duration` smallint unsigned NOT NULL DEFAULT '0' COMMENT '阅读时长',
    `date`     datetime COMMENT '日期',
    `content`  text NOT NULL COMMENT '正文',
    PRIMARY KEY (`id`)
) ENGINE = InnoDB
  COMMENT ='文章';
```

## 0x03 数据库连接

1. 在 pom.xml 中添加数据库相关依赖;
2. 这里使用 mybatis-plus 进行数据库层的增强, 简化开发.

```xml
<!-- 数据库 -->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
</dependency>
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid-spring-boot-starter</artifactId>
    <version>${druid.version}</version>
</dependency>
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
    <version>${mybatis-plus.version}</version>
</dependency>
```

## 0x04 读取\*.md 文件

1. 存量文章可通过[http://coderZsq.github.io/](https://github.com/coderZsq/coderZsq.github.io/tree/master/_posts)进行查看和获取;

2. 通过 commons-io 读取路径下的 62 篇存量文章;

```xml
<!-- IO -->
<dependency>
    <groupId>commons-io</groupId>
    <artifactId>commons-io</artifactId>
    <version>${commons-io.version}</version>
</dependency>
```

3. 由于使用了单元测试的方式进行读取, 获取 IoC 容器内容需要增加 @RunWith(SpringJUnit4ClassRunner.class) 和 @SpringBootTest(classes = RecorderApplication.class) 两个注解, 需添加以下依赖:

```xml
<dependency>
<groupId>junit</groupId>
    <artifactId>junit</artifactId>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
</dependency>
```

4. 使用 @Autowired 将 service 注入进来进行数据库操作;
5. 通过规则解析相关的内容, 将读取到的文件内容格式化存储至数据库;

```java
@RunWith(SpringJUnit4ClassRunner.class)
@SpringBootTest(classes = RecorderApplication.class)
public class ArticleTest {
    @Autowired
    private ArticleService service;

    @Test
    public void saveStockArticles() throws Exception {
        File directory = new File("/Users/zhushuangquan/Codes/GitHub/coderZsq.github.io/_posts");
        if (directory.isFile() || !directory.exists()) {
            return;
        }
        for (File file : Objects.requireNonNull(directory.listFiles())) {
            if (!"md".equals(FilenameUtils.getExtension(file.getName()))) continue;
            String input = FileUtils.readFileToString(file, "UTF-8");
            Article article = new Article();
            article.setContent(input.split("\n---\n\n")[1]
                            .replaceAll("!\\[.*\\]\\(.*\\)", "")
                            .replaceAll("<img.*\n", "")
                            .replaceAll("\".*/>", "")
            );
            article.setTitle(matchColumn(input, "title"));
            article.setType("stock");
            SimpleDateFormat fmt = new SimpleDateFormat("yyyy.MM.dd HH:mm");
            article.setDate(fmt.parse(matchColumn(input, "date")));
            int words = wordCount(input);
            article.setWords(words);
            article.setDuration(words / 350);
            service.save(article);
        }
    }
    ...
}
```

6. 解析存量文章中的头部格式:

```
---
layout: post
title: iOS 有效「阅读源码」的一些思考
date: 2019.02.27 23:13
tag: 移动开发
---
```

```java
private String matchColumn(String input, String column) {
    Pattern pattern = Pattern.compile(column + ": (.+)\n");
    Matcher matcher = pattern.matcher(input);
    if (!matcher.find()) return null;
    return matcher.group().substring(column.length() + 2).trim();
}
```

6. 字数统计方法, 用于统计出全文的字数.

```java
private int wordCount(String string) {
    if (string == null) {
        return 0;
    }
    String englishString = string.replaceAll("[\u4e00-\u9fa5]", "");
    String[] englishWords = englishString.split("[\\p{P}\\p{S}\\p{Z}\\s]+");
    int chineseWordCount = string.length() - englishString.length();
    int otherWordCount = englishWords.length;
    if (englishWords.length > 0 && englishWords[0].length() < 1) {
        otherWordCount--;
    }
    if (englishWords.length > 1 && englishWords[englishWords.length - 1].length() < 1) {
        otherWordCount--;
    }
    return chineseWordCount + otherWordCount;
}
```

## 0x05 数据库碰到的坑

1. 在插入 emoji 表情时会报以下错误:

```shell
Cause: java.sql.SQLException: Incorrect string value: '\xF0\x9F\x8C\x9F \xE9...' for column 'content' at row 1
```

- 原因是 MySQL 的默认字符编码是 utf8, 并不支持四个字符的 emoji 表情, 所以需要将数据库/表均改为 utf8mb4 编码进行支持.
- 配置 jdbc 时增加 characterEncoding=UTF-8 如下:

```shell
jdbc:mysql://localhost:3306/recorder?serverTimezone=GMT%2B8&characterEncoding=UTF-8
```

2. 在通过日期进行排序的时候会报如下错误:

```shell
Cause: Out of sort memory, consider increasing server sort buffer size, Time: 0.008000s
```

- 原因在于查询时的缓冲区被占满, 我们可以使用相关命令查看更改:

```sql
SHOW VARIABLES LIKE '%sort_buffer_size%';
SET GLOBAL sort_buffer_size = 1024*1024;
SET sort_buffer_size = 1024*1024;
```

- 这样我们就可以解决这个问题, 并对日期字段进行排序.

```sql
SELECT * FROM article ORDER BY date DESC
```

## 0x06 查询接口实现

1. 使用 mybatis-plus 简化数据库访问;
2. 开启只读事务, readOnly = true, 需要添加以下依赖:

```xml
<!-- AOP -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
</dependency>
```

3. 判断查询条件 id 和 type;
4. 通过 date 字段进行降序排序.

```java
@Service
@Transactional
public class ArticleServiceImpl extends ServiceImpl<ArticleMapper, Article> implements ArticleService {

    @Override
    @Transactional(readOnly = true)
    public PageVo<ArticleVo> list(ArticlePageReqVo query) {
        MpLambdaQueryWrapper<Article> wrapper = new MpLambdaQueryWrapper<>();
        Integer id = query.getId();
        if (id != null && id > 0) {
            wrapper.eq(Article::getId, id);
        }
        String type = query.getType();
        if (type != null) {
            wrapper.eq(Article::getType, type);
        }
        wrapper.orderByDesc(Article::getDate);
        return baseMapper
                .selectPage(new MpPage<>(query), wrapper)
                .buildVo(MapStructs.INSTANCE::po2vo);
    }
}
```

## 0x07 查询接口测试

1. 浏览器访问以下地址, 其中 type 字段用以区分是否为存量文章;

```shell
http://localhost:8080/articles?type=stock&id=51
```

2. 查看返回的数据结构.

```json
{
  "code": 0,
  "msg": "操作成功",
  "data": [
    {
      "id": 51,
      "title": "iOS 开发者该认真思考的「三个问题」",
      "type": "stock",
      "content": "...",
      "words": 3876,
      "duration": 11,
      "date": "2019-01-10T09:00:00.000+00:00"
    }
    ...
  ],
  "count": 1
}
```

## 0x08 查询接口文档

- GET /articles 分页查询.

| 字段 |    说明    |  类型  |        备注        | 是否必填 |
| :--: | :--------: | :----: | :----------------: | :------: |
|  id  |    主键    |  int   | 不传则返回全结果集 |    否    |
| type |    类型    | string |       默认""       |    否    |
| page |    页码    |  int   |       默认 1       |    否    |
| size | 每页的大小 |  int   |      默认 10       |    否    |
